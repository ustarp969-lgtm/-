<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Sprite Shooter (with Audio)</title>
<style>
  html,body{margin:0;height:100%;background:#0b1020;color:#fff;font-family:system-ui,-apple-system,sans-serif}
  canvas{display:block;width:100vw;height:100vh}
  #hud{position:fixed;left:10px;top:10px;z-index:5;font-weight:bold;text-shadow:0 2px 4px rgba(0,0,0,.6)}
  #start,#perm{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:10}
  #start button,#perm button{font-size:18px;padding:12px 18px;border-radius:10px;border:none}
  #ctrlL,#ctrlR,#ctrlShoot{position:fixed;pointer-events:auto;z-index:6}
  #ctrlL{left:0;bottom:0;width:50vw;height:110px;background:rgba(255,255,255,.06)}
  #ctrlR{right:0;bottom:0;width:50vw;height:110px;background:rgba(255,255,255,.10)}
  #ctrlShoot{left:0;top:0;width:100vw;height:34vh;background:rgba(255,255,255,.02)}
  #mute{position:fixed;right:10px;top:10px;z-index:7}
</style>
</head>
<body>
<canvas id="cv"></canvas>
<div id="hud">SCORE 0„ÄÄLIVES ‚ù§‚ù§‚ù§</div>
<button id="mute">üîä</button>
<div id="ctrlL"></div><div id="ctrlR"></div><div id="ctrlShoot"></div>
<div id="start"><button id="btnStart">„Ç≤„Éº„É†ÈñãÂßã</button></div>
<div id="perm" style="display:none"><button id="btnPerm">ÂÇæ„ÅçÊìç‰Ωú„ÇíÊúâÂäπÂåñ</button></div>

<script>
/* ===== Âü∫Êú¨„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÔºàHiDPIÂØæÂøúÔºâ ===== */
const cv=document.getElementById('cv'), cx=cv.getContext('2d');
const DPR = Math.max(1, devicePixelRatio || 1);
function fit(){
  cv.width = Math.floor(innerWidth * DPR);
  cv.height= Math.floor(innerHeight* DPR);
  cv.style.width = innerWidth + 'px';
  cv.style.height= innerHeight+ 'px';
  cx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize',fit); fit();

/* ===== „Ç¢„Çª„ÉÉ„ÉàË™≠„ÅøËæº„ÅøÔºà„ÅÇ„Çå„Å∞‰Ωø„ÅÜÔºèÁÑ°„Åë„Çå„Å∞„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ ===== */
function load(src){ return new Promise(r=>{ const x=new Image(); x.onload=()=>r({ok:true,img:x}); x.onerror=()=>r({ok:false}); x.src=src; });}
let SPR={bg:null,plane:null,bullet:null,enemy:null};
let SND={bgm:null,shoot:null,explode:null}, muted=false;

async function loadAssets(){
  const [bg,pl,bu,en] = await Promise.all([
    load('img/bg.jpg'), load('img/plane.png'), load('img/bullet.png'), load('img/enemy.png')
  ]);
  SPR.bg = bg.ok?bg.img:null;
  SPR.plane = pl.ok?pl.img:null;
  SPR.bullet= bu.ok?bu.img:null;
  SPR.enemy = en.ok?en.img:null;

  // Èü≥ÔºàÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ„Å†„Åë„Åó„Å¶„ÅÇ„Çå„Å∞ÂÜçÁîüÔºâ
  SND.bgm    = new Audio('audio/bgm.mp3');    SND.bgm.loop = true;
  SND.shoot  = new Audio('audio/shoot.wav');
  SND.explode= new Audio('audio/explode.wav');
  // Â§±Êïó„Åó„Å¶„ÇÇËêΩ„Å°„Å™„ÅÑ„Çà„ÅÜ„Å´try
  ['bgm','shoot','explode'].forEach(k=>{ SND[k].addEventListener('error',()=>SND[k]=null, {once:true}); });
}
loadAssets();

/* ===== Áä∂ÊÖã ===== */
const hud=document.getElementById('hud');
let running=false, over=false, last=0, spawn=0, score=0, lives=3;
const P={ x: innerWidth/2-24, y: innerHeight-110, w: 64, h: 64, vx:0, speed:260, fire:0 };
const bullets=[], enemies=[], particles=[];
function reset(){
  score=0; lives=3; over=false;
  P.x=innerWidth/2-P.w/2; P.y=innerHeight-110; P.vx=0; P.fire=0;
  bullets.length=0; enemies.length=0; particles.length=0; spawn=0;
  hud.textContent=`SCORE ${score}„ÄÄLIVES ${"‚ù§".repeat(lives)}`;
}
function rect(a,b){ return !(a.x+a.w<b.x || b.x+b.w<a.x || a.y+a.h<b.y || b.y+b.h<a.y); }
function burst(x,y,col){
  for(let i=0;i<18;i++){
    const a=Math.random()*Math.PI*2, s=60+Math.random()*160;
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:.4+.6*Math.random(),col});
  }
}
function drawSprite(img, x,y, w,h, rad=0, color=null){
  if(img){
    if(rad){ cx.save(); cx.translate(x+w/2,y+h/2); cx.rotate(rad); cx.drawImage(img,-w/2,-h/2,w,h); cx.restore();}
    else cx.drawImage(img,x,y,w,h);
  }else{
    if(rad){ cx.save(); cx.translate(x+w/2,y+h/2); cx.rotate(rad); cx.fillStyle=color||'#fff'; cx.fillRect(-w/2,-h/2,w,h); cx.restore();}
    else{ cx.fillStyle=color||'#fff'; cx.fillRect(x,y,w,h); }
  }
}

/* ===== „É°„Ç§„É≥„É´„Éº„Éó ===== */
function loop(t){
  if(!running){ requestAnimationFrame(loop); return; }
  const dt=Math.min(0.033,(t-last)/1000); last=t;

  // ËÉåÊôØ
  if(SPR.bg) cx.drawImage(SPR.bg,0,0,innerWidth,innerHeight);
  else{ cx.fillStyle='#0b1020'; cx.fillRect(0,0,innerWidth,innerHeight); cx.strokeStyle='rgba(255,255,255,.05)'; for(let y=0;y<innerHeight;y+=18){ cx.beginPath(); cx.moveTo(0,y+(t/40)%18); cx.lineTo(innerWidth,y+(t/40)%18); cx.stroke(); } }

  // „Éó„É¨„Ç§„É§„Éº
  P.x+=P.vx*dt; if(P.x<0)P.x=0; if(P.x+P.w>innerWidth) P.x=innerWidth-P.w;
  drawSprite(SPR.plane, P.x,P.y,P.w,P.h,0,'#30e0ff');

  // Âºæ
  P.fire-=dt;
  bullets.forEach(b=>{ b.y-=b.v*dt; b.rot+=10*dt; });
  for(let i=bullets.length-1;i>=0;i--) if(bullets[i].y<-60) bullets.splice(i,1);
  bullets.forEach(b=> drawSprite(SPR.bullet, b.x,b.y,b.w,b.h,b.rot,'#ffea00'));

  // Êïµ
  spawn-=dt;
  if(spawn<=0){
    const w=44,h=30; enemies.push({x:Math.random()*(innerWidth-w), y:-h-10, w,h, vy:80+Math.random()*120, hp:1});
    spawn=Math.max(.25, 1.1 - score*0.002);
  }
  enemies.forEach(e=> e.y+=e.vy*dt);
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    // Âºæ„Å®Ë°ùÁ™Å
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(rect(e,b)){
        bullets.splice(j,1); e.hp--; burst(e.x+e.w/2,e.y+e.h/2,'#ff7b00');
        if(SND.explode && !muted) SND.explode.currentTime=0, SND.explode.play();
        if(e.hp<=0){ enemies.splice(i,1); score+=10; hud.textContent=`SCORE ${score}„ÄÄLIVES ${"‚ù§".repeat(lives)}`; }
        break;
      }
    }
    if(e.y>innerHeight+40){ enemies.splice(i,1); }
  }
  enemies.forEach(e=> drawSprite(SPR.enemy, e.x,e.y,e.w,e.h,0,'#ff3b3b'));

  // Ë¢´Âºæ
  if(!over){
    for(const e of enemies){
      if(rect(P,e)){
        lives--; burst(P.x+P.w/2,P.y+P.h/2,'#ff3b3b');
        hud.textContent=`SCORE ${score}„ÄÄLIVES ${"‚ù§".repeat(Math.max(0,lives))}`;
        if(lives<=0){ gameOver(); }
        e.y=innerHeight+999; break;
      }
    }
  }

  // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´
  particles.forEach(p=>{ p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt; });
  for(let i=particles.length-1;i>=0;i--) if(particles[i].life<=0) particles.splice(i,1);
  particles.forEach(p=>{ cx.fillStyle=p.col; cx.fillRect(p.x,p.y,3,3); });

  requestAnimationFrame(loop);
}

function shoot(){
  if(P.fire>0) return;
  const W=26,H=30,V=600;
  bullets.push({ x:P.x+P.w/2-W/2, y:P.y-H, w:W, h:H, v:V, rot:0 });
  if(SND.shoot && !muted){ SND.shoot.currentTime=0; SND.shoot.play(); }
  P.fire=.12;
}
function gameOver(){
  over=true; running=false;
  document.getElementById('start').style.display='flex';
  document.getElementById('btnStart').textContent=`GAME OVER / „É™„Çπ„Çø„Éº„ÉàÔºà${score}Ôºâ`;
}

/* ===== Êìç‰ΩúÔºà„Çø„ÉÉ„ÉÅ + „Ç∏„É£„Ç§„É≠Ôºâ ===== */
const ctrlL=document.getElementById('ctrlL');
const ctrlR=document.getElementById('ctrlR');
const ctrlShoot=document.getElementById('ctrlShoot');
let holdL=false, holdR=false;
function updateVX(){ if(!gyro.enabled){ P.vx = (holdR?1:0 - (holdL?1:0)) * P.speed; } }
['touchstart','mousedown'].forEach(ev=>{
  ctrlL.addEventListener(ev,()=>{holdL=true; updateVX();},{passive:true});
  ctrlR.addEventListener(ev,()=>{holdR=true; updateVX();},{passive:true});
  ctrlShoot.addEventListener(ev,()=>shoot(),{passive:true});
});
['touchend','mouseup','mouseleave','touchcancel'].forEach(ev=>{
  ctrlL.addEventListener(ev,()=>{holdL=false; updateVX();},{passive:true});
  ctrlR.addEventListener(ev,()=>{holdR=false; updateVX();},{passive:true});
});
let dragging=false,lastX=0;
addEventListener('touchstart',e=>{ dragging=true; lastX=e.touches[0].clientX; },{passive:true});
addEventListener('touchmove',e=>{ if(!dragging)return; const x=e.touches[0].clientX; const dx=x-lastX; lastX=x; P.x+=dx*0.8; },{passive:true});
addEventListener('touchend',()=>{ dragging=false; });

// „Ç∏„É£„Ç§„É≠
const permPane=document.getElementById('perm');
const gyro={enabled:false};
async function requestGyro(){
  try{
    if(typeof DeviceOrientationEvent!=='undefined' &&
       typeof DeviceOrientationEvent.requestPermission==='function'){
      const r=await DeviceOrientationEvent.requestPermission();
      if(r!=='granted') throw new Error('denied');
    }
    gyro.enabled=true; permPane.style.display='none';
  }catch{ gyro.enabled=false; permPane.style.display='none'; }
}
addEventListener('deviceorientation',e=>{
  if(!gyro.enabled) return;
  const g=e.gamma||0;
  if(Math.abs(g)<4) P.vx=0;
  else P.vx=(g>0?1:-1)*P.speed*Math.min(1,Math.abs(g)/25);
});

/* ===== ÈñãÂßã„ÉªÈü≥Èñ¢‰øÇ ===== */
document.getElementById('btnStart').addEventListener('click',()=>{
  reset(); running=true; document.getElementById('start').style.display='none'; last=performance.now(); requestAnimationFrame(loop);
  // iOS„ÅØ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂæå„Åß„Å™„ÅÑ„Å®ÂÜçÁîü„Åß„Åç„Å™„ÅÑ
  if(SND.bgm && !muted){ SND.bgm.currentTime=0; SND.bgm.play().catch(()=>{}); }
  if(!gyro.enabled && ('DeviceOrientationEvent' in window)) permPane.style.display='flex';
});
document.getElementById('btnPerm').addEventListener('click',requestGyro);

// „Éü„É•„Éº„ÉàÂàáÊõø
const btnMute=document.getElementById('mute');
btnMute.addEventListener('click',()=>{
  muted=!muted;
  btnMute.textContent = muted?'üîá':'üîä';
  if(muted && SND.bgm){ SND.bgm.pause(); }
  if(!muted && SND.bgm){ SND.bgm.play().catch(()=>{}); }
});

document.addEventListener('visibilitychange',()=>{
  if(document.hidden){ running=false; if(SND.bgm) SND.bgm.pause(); }
  else if(!over && document.getElementById('start').style.display==='none'){
    running=true; last=performance.now(); requestAnimationFrame(loop);
    if(SND.bgm && !muted) SND.bgm.play().catch(()=>{});
  }
});
</script>
</body>
</html>
